<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Process ID Mỗi process đều có một unique ID, nó giống như số chứng minh nhân dân của mình vậy. Thử chạy command sau ở irb (interactive ruby), ta có process đang chạy irb có ID là 96160."><title>Unix Process notes</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://namtx.dev/icon.png><link href=https://namtx.dev/styles.6d35b443b4f220f750e7bcd3c17d1fcf.min.css rel=stylesheet><link href=https://namtx.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://namtx.dev/js/darkmode.96130cf4662e948e7d494ad9fe8349bb.min.js></script>
<script src=https://namtx.dev/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://namtx.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://namtx.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://namtx.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://namtx.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://namtx.dev",fetchData=Promise.all([fetch("https://namtx.dev/indices/linkIndex.731a989f4078d5c2a56f4429eda47f20.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://namtx.dev/indices/contentIndex.83edef775dd05ea80edfe5166d2b1537.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://namtx.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://namtx.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/namtx.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://namtx.dev/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://namtx.dev><svg viewBox="0 0 100 100" width="30" height="30"><defs><linearGradient id="a" x1="82.85" y1="30.41" x2="51.26" y2="105.9" gradientTransform="matrix(1, 0, 0, -1, -22.41, 110.97)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#6c56cc"/><stop offset="1" stop-color="#9785e5"/></linearGradient></defs><polygon points="44.61 0 12.91 17.52 0 45.45 19.57 90.47 47.35 100 52.44 89.8 63 26.39 44.61 0" fill="#34208c"/><polygon points="63 26.39 43.44 14.41 16.43 35.7 47.35 100 52.44 89.8 63 26.39" fill="url(#a)"/><polygon points="63 26.39 63 26.39 44.61 0 43.44 14.41 63 26.39" fill="#af9ff4"/><polygon points="43.44 14.41 44.61 0 12.91 17.52 16.43 35.7 43.44 14.41" fill="#4a37a0"/><polygon points="16.43 35.7 19.57 90.47 47.35 100 16.43 35.7" fill="#4a37a0"/></svg>Obsidian</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Unix Process notes</h1><p class=meta>Last updated
Dec 31, 2022</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li><a href=#process-id>Process ID</a></li><li><a href=#parent-process>Parent process</a></li><li><a href=#file-descriptor>File descriptor</a></li><li><a href=#fork-process>Fork process</a></li><li><a href=#orphaned-processes>Orphaned Processes</a></li><li><a href=#processwait>Process.wait</a></li><li><a href=#zoombie-process>Zoombie process</a></li></ol></li></ol></nav></details></aside><a href=#process-id><h3 id=process-id><span class=hanchor arialabel=Anchor># </span>Process ID</h3></a><p>Mỗi process đều có một unique ID, nó giống như số chứng minh nhân dân của mình vậy.
Thử chạy command sau ở <code>irb</code> (interactive ruby), ta có process đang chạy <code>irb</code> có ID là <code>96160</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>puts</span> <span class=no>Process</span><span class=o>.</span><span class=n>pid</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>96160</span>
</span></span></code></pre></td></tr></table></div></div><p>Mở một terminal khác rồi chạy command sau, ta sẽ lấy được một số thông tin cơ bản về process đó thông qua ID.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>ps -p &lt;process-id&gt;
</span></span></span><span class=line><span class=cl><span class=go>  PID TTY           TIME CMD
</span></span></span><span class=line><span class=cl><span class=go>96160 ttys002    0:00.45 irb
</span></span></span></code></pre></td></tr></table></div></div><a href=#parent-process><h3 id=parent-process><span class=hanchor arialabel=Anchor># </span>Parent process</h3></a><p>Mỗi process chạy OS đều có process cha, nó có thể lấy process ID của process cha bằng <code>ppid</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>Process</span><span class=o>.</span><span class=n>ppid</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>24569</span>
</span></span></code></pre></td></tr></table></div></div><p>Thử đoán xem process có ID <code>24569</code> là process nào?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>ps -p 24569
</span></span></span><span class=line><span class=cl><span class=go>  PID TTY           TIME CMD
</span></span></span><span class=line><span class=cl><span class=go>24569 ttys002    0:04.95 -zsh
</span></span></span></code></pre></td></tr></table></div></div><p>Vì mình chạy <code>irb</code> thông qua <code>zsh</code> nên process cha của <code>irb</code> sẽ là <code>zsh</code>.</p><a href=#file-descriptor><h3 id=file-descriptor><span class=hanchor arialabel=Anchor># </span>File descriptor</h3></a><blockquote><p>in the land of Unix ‘everything is a file’</p></blockquote><p>Giống như mỗi process đều có một unique ID, bất cứ lúc nào chúng ta mở một resource (files, sockets, devices,&mldr;) trong một process, thì resource đó cũng được đánh số thứ tự <code>fileno</code>
<code>fileno</code> sẽ luôn là số nhỏ nhất mà chưa được sử dụng</p><p>Run command sau ở <code>irb</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>passwd</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;/etc/passwd&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=n>passwd</span><span class=o>.</span><span class=n>fileno</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hosts</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;/etc/hosts&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=n>hosts</span><span class=o>.</span><span class=n>fileno</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Khi close file, thì file descriptor cũng sẽ bị xoá</span>
</span></span><span class=line><span class=cl><span class=c1># fileno `3` sẽ có thể được sử dụng lại khi process mở một resource khác.</span>
</span></span><span class=line><span class=cl><span class=n>passwd</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>null</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s1>&#39;/dev/null&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=n>null</span><span class=o>.</span><span class=n>fileno</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>3</span>
</span></span></code></pre></td></tr></table></div></div><p>Chúng ta có thể thắc mắc ở đây</p><blockquote><p><code>fileno</code> sẽ luôn là số nhỏ nhất mà chưa được sử dụng</p></blockquote><p>ở trên chỉ thấy <code>fileno</code> là <code>3</code> là nhỏ nhất, vậy <code>0</code>, <code>1</code>, <code>2</code> đi đâu rồi?</p><p>Câu trả lời là, mỗi process khi chạy đều sẽ mở sẵn 3 resources. <code>STDIN</code>, <code>STDOUT</code>, <code>STDERR</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>puts</span> <span class=no>STDIN</span><span class=o>.</span><span class=n>fileno</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>STDOUT</span><span class=o>.</span><span class=n>fileno</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>STDERR</span><span class=o>.</span><span class=n>fileno</span>
</span></span><span class=line><span class=cl> <span class=o>=&gt;</span> <span class=mi>2</span>
</span></span></code></pre></td></tr></table></div></div><p>Đây là 3 resources tiêu chuẩn của mỗi process.</p><ul><li><code>STDIN</code> (input) là để nhận input từ keyboard, pipes (nhận user input từ bàn phím)</li><li><code>STDOUT</code> (output) là để process có thể ghi output ra ngoài devices, (in kết quả ra terminal)</li><li><code>STDERR</code> (error) là để process có thể ghi lỗi ra bên ngoài (ghi lỗi ra file log chẳng hạn)</li></ul><a href=#fork-process><h3 id=fork-process><span class=hanchor arialabel=Anchor># </span>Fork process</h3></a><p>Để tạo một process con từ một process cha, UNIX cung cấp cho chúng ta một API <code>fork</code></p><p>Process con sau khi fork từ process cha sẽ giống hệt process cha từ memory đến file descriptor.</p><p>Như đoạn đầu đã giới thiệu, process con sẽ có <code>ppid</code> là <code>pid</code> của process cha.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># In ra process id hiện tại</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=s2>&#34;Parent process ID: </span><span class=si>#{</span><span class=no>Process</span><span class=o>.</span><span class=n>pid</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># =&gt; Parent process ID: 99719</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># fork một child process</span>
</span></span><span class=line><span class=cl><span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=c1># In ra process id của child process</span>
</span></span><span class=line><span class=cl>	<span class=nb>puts</span> <span class=no>Process</span><span class=o>.</span><span class=n>pid</span>
</span></span><span class=line><span class=cl>	<span class=c1># =&gt; 99762</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># In ra parent process id của child process</span>
</span></span><span class=line><span class=cl>	<span class=nb>puts</span> <span class=no>Process</span><span class=o>.</span><span class=n>ppid</span>
</span></span><span class=line><span class=cl>	<span class=c1># =&gt; 99719</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><p>Process con sẽ thừa kế lại toàn bộ file descriptor đang mở của process cha. <code>fileno</code> cũng sẽ không hề thay đổi. Vì vậy nên process con có thể dùng chung file, sockets với process cha.</p><p>Process con cũng sẽ thừa kế toàn bộ memory của process cha.</p><p>Ví dụ, chúng ta có một app Rails trong RAM 500MB, thì khi fork một process, process con cũng sẽ chiếm thêm 500MB memory copy từ process cha.</p><p>Sử dụng <code>fork</code> cho phép chúng ta có thể tạo thêm nhiều App instances trong tích tắc.</p><p>Nhưng như đã nói ở trên, việc copy sẽ rất tốn kém về RAM.</p><p>UNIX optimize nhược điểm trên bằng cơ chế copy-on-write (CoW), sau khi <code>fork</code>, nếu process cha hoặc process con chưa modify lại data thì việc copy sẽ được delay, và chỉ được thực hiện khi process cha hoặc process con modify.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>arr</span> <span class=o>=</span> <span class=o>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=c1># Bên trong process con</span>
</span></span><span class=line><span class=cl>	<span class=c1># Tại thời điểm này, process con chưa modify `arr` nên nó sẽ tiếp tục đọc shared data từ process cha, không copy data</span>
</span></span><span class=line><span class=cl>	<span class=nb>puts</span> <span class=n>arr</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>arr</span> <span class=o>=</span> <span class=o>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=c1># giống như ở phía trên, chưa có quá trình copy nào xảy ra cả</span>
</span></span><span class=line><span class=cl>	<span class=n>arr</span> <span class=o>&lt;&lt;</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>	<span class=c1># Dòng code trên modify `arr` nên một bản copy của `arr` sẽ được tạo trong memory, và process con sẽ đọc từ đó, process cha vẫn tiếp tục đọc từ vùng nhớ của riêng nó, không liên quan đến process con.</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></td></tr></table></div></div><a href=#orphaned-processes><h3 id=orphaned-processes><span class=hanchor arialabel=Anchor># </span>Orphaned Processes</h3></a><p>Chuyện gì sẽ xảy ra nếu sau khi <code>fork</code> một process con, và trong khi process con đó đang chạy thì process cha bị kill?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># test_orphan.rb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=mi>5</span><span class=o>.</span><span class=n>times</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>		<span class=nb>sleep</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=nb>puts</span> <span class=s2>&#34;I&#39;m an orphan&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>abort</span> <span class=s2>&#34;Parent process dies...&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>khi chạy file trên ở terminal bằng <code>ruby test_orphan.rb</code>, ta sẽ thấy parent process sẽ dừng ngay lập tức, nhưng mà process vẫn còn chạy tiếp, process con vẫn còn tiếp tục ghi output ra <code>STDOUT</code> (terminal)</p><p>Khi một parent process die, OS sẽ để nguyên process con, không làm gì nó cả, nó vẫn sẽ tiếp tục chạy.</p><p>Vậy, orphan child process thì có tác dụng gì?</p><ul><li>Daemon process: thông thường khi ta muốn chạy một long running processes như: database server hay web server, chúng ta sẽ chạy ở chế độ daemon. Daemon process đơn giản là process được chủ ý cho trở thành orphan process.</li><li>Vậy làm sao chúng ta có thể giao tiếp với orphan process? ta có thể giao tiếp với orphan process bằng UNIX signals.</li></ul><a href=#processwait><h3 id=processwait><span class=hanchor arialabel=Anchor># </span>Process.wait</h3></a><p>Từ những ví dụ ở trên, ta có thể thấy process cha sau khi fork sẽ chạy song song với process con, và sẽ xảy ra những case như trên, khi process cha đã exit nhưng process con vẫn còn chạy.</p><p>Vậy làm sao process cha có thể quản lý được các process con?</p><p>Trong Ruby, chúng ta có thể sử dụng <code>Process.wait</code> ở proces cha để có thể chờ cho process con exit.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=mi>5</span><span class=o>.</span><span class=n>times</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>		<span class=nb>sleep</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=nb>puts</span> <span class=s2>&#34;Child process&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=no>Process</span><span class=o>.</span><span class=n>wait</span>
</span></span><span class=line><span class=cl><span class=nb>abort</span> <span class=s2>&#34;Parent process exits...&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Output:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Child process
</span></span></span><span class=line><span class=cl><span class=go>Child process
</span></span></span><span class=line><span class=cl><span class=go>Child process
</span></span></span><span class=line><span class=cl><span class=go>Child process
</span></span></span><span class=line><span class=cl><span class=go>Child process
</span></span></span><span class=line><span class=cl><span class=go>Parent process exits...
</span></span></span></code></pre></td></tr></table></div></div><p><code>Process.wait</code> là blocking call, nghĩa là process cha sẽ dừng lại để chờ cho một process con exit, sau đó nó sẽ tiếp tục công việc của mình.</p><p><strong>Chờ nhiều process con???</strong></p><p>Do <code>Process.wait</code> chỉ chờ duy nhất 1 process con exit nên khi có nhiều process con, ta phải gọi <code>Process.wait</code> tương ứng với số process con đang chạy</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=mi>5</span><span class=o>.</span><span class=n>times</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>		<span class=nb>sleep</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=nb>puts</span> <span class=s2>&#34;Child process&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl><span class=mi>5</span><span class=o>.</span><span class=n>times</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=no>Process</span><span class=o>.</span><span class=n>wait</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=s2>&#34;Parent process exits...&#34;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#race-condition><h4 id=race-condition><span class=hanchor arialabel=Anchor># </span>Race condition</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># Fork ra 2 process con</span>
</span></span><span class=line><span class=cl><span class=mi>2</span><span class=o>.</span><span class=n>times</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>	<span class=nb>fork</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>		<span class=c1># Process con exit ngay lập tức</span>
</span></span><span class=line><span class=cl>		<span class=nb>abort</span> <span class=s2>&#34;Children process finished&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Process cha chờ process con đầu tiên exit, sau đó sleep 5s</span>
</span></span><span class=line><span class=cl><span class=c1># Trong khi process cha đang sleep thì process con thứ 2 exit.</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>Process</span><span class=o>.</span><span class=n>wait</span>
</span></span><span class=line><span class=cl><span class=nb>sleep</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thông tin về process thứ 2 vẫn còn lúc sau đó</span>
</span></span><span class=line><span class=cl><span class=c1># OS đã lưu lại info của process ngay cả sau khi nó exit.</span>
</span></span><span class=line><span class=cl><span class=nb>puts</span> <span class=no>Process</span><span class=o>.</span><span class=n>wait</span>
</span></span></code></pre></td></tr></table></div></div><p>Có thể thấy, OS sẽ lưu lại info của process con và trả về cho process cha, ngay cả khi process con đã exit rất lâu.</p><a href=#zoombie-process><h3 id=zoombie-process><span class=hanchor arialabel=Anchor># </span>Zoombie process</h3></a><p>Việc lưu lại info của process con và trả về cho process cha có một vấn đề, đó là mặc dù process con đã kết thúc từ rất lâu, nhưng nếu process cha không gọi <code>Process.wait</code> thì info về trạng thái của process con sẽ tồn tại mãi, khiến cho việc sử dụng tài nguyên của OS không hiệu quả.
Và process con sẽ trở thành <code>Zoombie process</code>.</p><p>Chúng ta có thể sử dụng <code>Process.detach(pid)</code> để có clean up.</p><p><code>Process.detach</code> đơn giản chỉ tạo ra một thread và làm một việc đơn giản là chờ process con đó kết thúc.</p><p><a href=https://github.com/namtx/til/issues/148 rel=noopener>Process.detach</a></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://namtx.dev/js/graph.43449bd0c1e2fba6f4d85a25d9cfaee8.js></script></div></div><div id=contact_buttons><footer><p>Made by Nam Tran using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://namtx.dev>Home</a></li><li><a href=https://github.com/namtx>Github</a></li></ul></footer></div></div></body></html>
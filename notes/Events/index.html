<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Event Types Change Data Capture Events (CDC)  refers to the process of capturing changes made to a database Row level changes or schema level changes CDC Events MUST NOT be consumed by consumers (µS) outside the Bounded Context which owns the data For example: Company data is owned and served by Monolith."><title>Events</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://namtx.dev/icon.png><link href=https://namtx.dev/styles.6d35b443b4f220f750e7bcd3c17d1fcf.min.css rel=stylesheet><link href=https://namtx.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://namtx.dev/js/darkmode.96130cf4662e948e7d494ad9fe8349bb.min.js></script>
<script src=https://namtx.dev/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://namtx.dev/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://namtx.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://namtx.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://namtx.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://namtx.dev",fetchData=Promise.all([fetch("https://namtx.dev/indices/linkIndex.8a46b8fcbf86eade9a042e8cbe39f298.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://namtx.dev/indices/contentIndex.84b0e2eb28595249a3c8d4ce4988717a.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://namtx.dev",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://namtx.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'’':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/namtx.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://namtx.dev/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://namtx.dev><svg viewBox="0 0 100 100" width="30" height="30"><defs><linearGradient id="a" x1="82.85" y1="30.41" x2="51.26" y2="105.9" gradientTransform="matrix(1, 0, 0, -1, -22.41, 110.97)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#6c56cc"/><stop offset="1" stop-color="#9785e5"/></linearGradient></defs><polygon points="44.61 0 12.91 17.52 0 45.45 19.57 90.47 47.35 100 52.44 89.8 63 26.39 44.61 0" fill="#34208c"/><polygon points="63 26.39 43.44 14.41 16.43 35.7 47.35 100 52.44 89.8 63 26.39" fill="url(#a)"/><polygon points="63 26.39 63 26.39 44.61 0 43.44 14.41 63 26.39" fill="#af9ff4"/><polygon points="43.44 14.41 44.61 0 12.91 17.52 16.43 35.7 43.44 14.41" fill="#4a37a0"/><polygon points="16.43 35.7 19.57 90.47 47.35 100 16.43 35.7" fill="#4a37a0"/></svg>Obsidian</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Events</h1><p class=meta>Last updated
Dec 31, 2022</p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><ol><li><a href=#event-types>Event Types</a></li><li><a href=#event-structure>Event Structure</a></li><li><a href=#versioning>Versioning</a></li></ol></li></ol></nav></details></aside><a href=#event-types><h3 id=event-types><span class=hanchor arialabel=Anchor># </span>Event Types</h3></a><a href=#change-data-capture-events-cdc><h4 id=change-data-capture-events-cdc><span class=hanchor arialabel=Anchor># </span>Change Data Capture Events (CDC)</h4></a><ul><li>refers to the process of capturing changes made to a database</li><li>Row level changes or schema level changes</li><li>CDC Events <strong>MUST NOT</strong> be consumed by consumers (µS) outside the Bounded Context which owns the data</li><li>For example: Company data is owned and served by Monolith. Extracting all logic into a separate µS requires data to be migrated as well, since every service maintains its own datastore. Having CDC event streaming in place would allow the µS to migrate the changes to its datastore.</li><li>Visibility: CDC events are private messages, and hence the events must be produced to/consumed from private topics. Kafka allows configuring ACL for restricted accesses.</li></ul><a href=#entity-changed-events-ece><h4 id=entity-changed-events-ece><span class=hanchor arialabel=Anchor># </span>Entity Changed Events (ECE)</h4></a><p><a href=/notes/ECEs-Entity-Changed-Events rel=noopener class=internal-link data-src=/notes/ECEs-Entity-Changed-Events>ECEs - Entity Changed Events</a></p><ul><li>represent a data structure with the intent of presenting changes in a entity. This at first might sound similar to CDC, but conceptually they&rsquo;re different. ECE Events define a public contract, which can be used by Foreign Bounded Contexts. They&rsquo;re used primarily for <strong>Data Replication</strong> between different systems. For the consumers that listen to ECEs, the guarantee is that they will receive the latest state of an entity, but might not receive all the intermediates states, due to #compaction.</li></ul><a href=#how-is-different-from-cdc><h5 id=how-is-different-from-cdc><span class=hanchor arialabel=Anchor># </span>How is different from CDC?</h5></a><ul><li>CDC could be the basis of Entity Changed Events, there are scenarios where the produced may directly produce such an event without need for CDC.</li><li>CDC events are granular as they can expose Table/Schema/Row Level changes.</li><li>ECEs can communicate changes on Domain Entity, i.e. <code>Company</code> could be a domain model and <code>CompanyChangedEvent</code> will present changes on that model. The important point here is that the persistence model could span several tables.</li></ul><a href=#domain-events><h4 id=domain-events><span class=hanchor arialabel=Anchor># </span>Domain Events</h4></a><p>Domain Events are described as something that happened in the domain. Just like Entity Changed Events, domain events also define a public contract. Such events typically occur regardless of whether or to what extent the domain is implemented in software development. They are also independent of technologies.</p><ul><li>An employee is hired</li><li>An employee is fired</li><li>An candidate rejected an offer.</li></ul><p>Domain events are relevant both within a bounded context and across bounded context for implementing processes within the domain. Domain events are suited to inform other bounded contexts about specific business-related events that have occurred.</p><a href=#when-to-use-entity-changed-events-vs-domain-events><h5 id=when-to-use-entity-changed-events-vs-domain-events><span class=hanchor arialabel=Anchor># </span>When to use Entity Changed Events vs Domain Events?</h5></a><ul><li>Only data replication, then Entity Changed Event will suffice their need.</li><li>Executing business logic in reaction to change in another system, then Domain Events should be preferred.</li></ul><a href=#event-structure><h3 id=event-structure><span class=hanchor arialabel=Anchor># </span>Event Structure</h3></a><ul><li>&ldquo;Fat&rdquo; events are preferred. This is to ensure that a consumer is able to action an event without having to make a sync cal to the producer service.</li></ul><a href=#cdc><h5 id=cdc><span class=hanchor arialabel=Anchor># </span>CDC</h5></a><p>The structure of the CDC events are fixed by the <a href=/notes/Debezium-Connectors rel=noopener class=internal-link data-src=/notes/Debezium-Connectors>Debezium Connectors</a></p><a href=#entity-change-event><h5 id=entity-change-event><span class=hanchor arialabel=Anchor># </span>Entity Change Event</h5></a><p>Entity change event contain the state of the entity after the change. Optional event metadata, like <code>company_id</code> or <code>employee_id</code> (when applicable) should be included on the root level for both <code>changed</code> and <code>deleted</code> events.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>message</span><span class=w> </span><span class=n>FoorBarEvent</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>oneOf</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FooBarChangedEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FooBarDeletedEvent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>message</span><span class=w> </span><span class=n>FooBarChangedEvent</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=n>optional</span><span class=w> </span><span class=n>additional</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=o>`</span><span class=n>company_id</span><span class=o>`</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=o>`</span><span class=n>employee_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>FooBar</span><span class=w> </span><span class=n>entity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>message</span><span class=w> </span><span class=n>FooBarDeletedEvent</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>//</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=n>optional</span><span class=w> </span><span class=n>additional</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=o>`</span><span class=n>company_id</span><span class=o>`</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=o>`</span><span class=n>employee_id</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>message</span><span class=w> </span><span class=n>FooBar</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>string</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>string</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>int64</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Entity ID must be present in the key of the <a href=/notes/Kafka rel=noopener class=internal-link data-src=/notes/Kafka>Kafka</a> record in addition to the payload (to allow partitioning, ordering, and compaction). The event metadata described below should be encoded as <a href=/notes/Kafka rel=noopener class=internal-link data-src=/notes/Kafka>Kafka</a> record headers. Notes, that there is no <code>eventName</code> specified neither in the message payload, nor in the metadata. Parsing event payloads is make possible by using <code>oneOf</code> type definition.</p><p>Because the event log is only guaranteed to have the latest Entity Changed Event and not the full history of events. Not all entity change events are guaranteed to be processed by all consumers. Hence, having both the previous and current state of the entity inside the entity change event can cause issues when reprocessing the messages from a compacted log or restarting a consumer after a long pause.
When using Kafka, we must provide a way to automatically remove records that were deleted from the event log. For this, a tombstone message with null values is required. Hence, consumer should be prepared to handle those messages and should not rely on the <code>entity deleted</code> messages in the long run.</p><a href=#versioning><h3 id=versioning><span class=hanchor arialabel=Anchor># </span>Versioning</h3></a><p>Follow this guide when you want to update the ECEs message:
<a href=https://developers.google.com/protocol-buffers/docs/proto3#updating rel=noopener>https://developers.google.com/protocol-buffers/docs/proto3#updating</a></p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://namtx.dev/js/graph.43449bd0c1e2fba6f4d85a25d9cfaee8.js></script></div></div><div id=contact_buttons><footer><p>Made by Nam Tran using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://namtx.dev>Home</a></li><li><a href=https://github.com/namtx>Github</a></li></ul></footer></div></div></body></html>